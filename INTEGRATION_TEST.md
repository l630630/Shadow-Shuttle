# M1+M2 集成测试计划

## 测试目标

验证 Headscale 协调服务器（M1）和 Shadowd 守护进程（M2）的基础功能和集成。

## 测试环境

- 操作系统: macOS (darwin)
- Go 版本: 需要验证
- Docker: 需要验证

## 测试步骤

### 阶段 1: 环境检查

- [ ] 1.1 检查 Go 环境
- [ ] 1.2 检查 Docker 环境
- [ ] 1.3 检查项目依赖

### 阶段 2: 构建测试

- [ ] 2.1 构建 Shadowd 主程序
- [ ] 2.2 构建 Shadowd 服务管理器
- [ ] 2.3 运行单元测试

### 阶段 3: Headscale 部署测试

- [ ] 3.1 启动 Headscale 容器
- [ ] 3.2 验证 Headscale 服务可访问
- [ ] 3.3 创建命名空间

### 阶段 4: Shadowd 功能测试

- [ ] 4.1 验证配置文件加载
- [ ] 4.2 测试 Shadowd 启动（开发模式）
- [ ] 4.3 验证 SSH 服务器监听
- [ ] 4.4 验证 gRPC 服务器监听

### 阶段 5: 集成验证

- [ ] 5.1 验证 WireGuard 连接逻辑
- [ ] 5.2 测试 gRPC 接口调用
- [ ] 5.3 测试 SSH 连接（模拟）

## 测试结果

测试开始时间: 2025-01-28 20:45
测试完成时间: 2025-01-28 21:36
总体状态: 部分完成

### 阶段 1: 环境检查 ✅

#### 1.1 检查 Go 环境 ✅
- Go 版本: go1.25.5 darwin/arm64
- 状态: 已安装

#### 1.2 检查 Docker 环境 ✅
- Docker 版本: 28.5.1
- Docker Compose 版本: v2.40.3
- 状态: 正常

#### 1.3 检查项目依赖 ✅
- 所有 Go 依赖已下载
- go.sum 已重新生成

### 阶段 2: 构建测试 ✅

#### 2.1 构建 Shadowd 主程序 ✅
- 文件: shadowd/shadowd (15MB)
- 状态: 构建成功
- 问题修复:
  - 修复了 wireguard.go 文件写入问题（创建为 wg.go）
  - 修复了 gRPC DeviceServiceServer 类型冲突
  - 修复了 service 构建标签
  - 移除了 main.go 中未使用的 fmt 导入

#### 2.2 构建 Shadowd 服务管理器 ⚠️
- 状态: 编译失败（service 包问题）
- 原因: newWindowsService 和 newLinuxService 在 macOS 上未定义
- 影响: 不影响主程序运行

#### 2.3 运行单元测试 ⚠️
- config 包: 5/8 测试通过（配置验证问题）
- network 包: 11/11 测试全部通过 ✅
- ssh 包: 编译失败（测试 mock 问题）
- grpc 包: 编译失败（测试需要更新）

### 阶段 3: Headscale 部署测试 ⏸️
- 等待阶段 2 完成后继续

### 阶段 4: Shadowd 功能测试 ⏸️
- 等待阶段 3 完成后继续

### 阶段 5: 集成验证 ⏸️
- 等待阶段 4 完成后继续

## 问题总结

### 已解决
1. ✅ Go 环境安装
2. ✅ go.sum 校验和不匹配
3. ✅ wireguard.go 文件写入问题
4. ✅ gRPC 类型冲突
5. ✅ 构建标签格式
6. ✅ 主程序编译成功

### 待解决
1. ⚠️ service 包跨平台编译问题
2. ⚠️ SSH 和 gRPC 测试文件需要更新
3. ⚠️ config 包验证逻辑需要调整

### 下一步建议
1. 创建配置文件并测试 shadowd 启动
2. 部署 Headscale 服务器
3. 验证 SSH 和 gRPC 接口
4. 修复测试文件（可选）

