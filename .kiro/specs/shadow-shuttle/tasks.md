# 实施计划: 影梭 (Shadow Shuttle)

## 概述

本实施计划将影梭系统分为四个主要模块，按照依赖关系逐步实现。首先部署 Headscale 协调服务器作为基础设施，然后开发 Shadowd 守护进程，最后实现移动端应用的网络连接和终端功能。每个模块都包含核心实现和对应的测试任务。

## 任务

- [x] 1. M1: 部署和配置 Headscale 协调服务器
  - 创建 Docker Compose 配置文件
  - 配置 Headscale 服务器（IP 前缀、OIDC、端口）
  - 编写部署脚本和文档
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ]* 1.1 编写 Headscale 部署验证测试
  - 验证 Docker 容器启动成功
  - 验证 `headscale nodes list` 命令可用
  - 验证 OIDC 登录端点可访问
  - _需求: 1.1, 1.2_

- [ ]* 1.2 编写设备注册属性测试
  - **属性 1: 设备 IP 唯一性**
  - **验证需求: 1.3**

- [ ]* 1.3 编写设备持久化属性测试
  - **属性 2: 设备信息持久化往返**
  - **验证需求: 1.4**

- [x] 2. M2: 实现 Shadowd 守护进程核心功能
  - [x] 2.1 创建 Go 项目结构和配置管理
    - 初始化 Go 模块和依赖
    - 实现配置文件解析（YAML）
    - 定义核心数据结构（Device、Config）
    - _需求: 2.1, 2.4_

  - [x] 2.2 实现 WireGuard 集成和 Headscale 连接
    - 集成 WireGuard Go 库
    - 实现 Headscale 注册逻辑
    - 实现心跳和健康检查
    - _需求: 2.1, 2.4_

  - [ ]* 2.3 编写网络连接单元测试
    - 测试 Headscale 注册流程
    - 测试心跳机制
    - _需求: 2.1, 2.4_

  - [ ]* 2.4 编写自动重连属性测试
    - **属性 5: 网络断线自动重连**
    - **验证需求: 2.5**

  - [x] 2.5 实现 SSH 服务器接口
    - 配置 SSH 服务器监听 Mesh IP
    - 实现密钥认证（禁用密码认证）
    - 实现访问控制（仅 Mesh 网络）
    - _需求: 2.2, 5.2, 5.3_

  - [ ]* 2.6 编写 SSH 连接属性测试
    - **属性 3: SSH 连接可达性**
    - **验证需求: 2.2**

  - [ ]* 2.7 编写 SSH 安全属性测试
    - **属性 18: SSH 密钥认证强制**
    - **属性 19: Mesh 网络访问控制**
    - **验证需求: 5.2, 5.3**

  - [x] 2.6 实现 gRPC-Web 接口
    - 定义 gRPC 服务（DeviceService）
    - 实现 GetDeviceInfo、GeneratePairingCode、HealthCheck
    - 配置 gRPC-Web 代理
    - _需求: 2.3, 2.6_

  - [ ]* 2.7 编写 gRPC 接口属性测试
    - **属性 4: gRPC 接口响应性**
    - **验证需求: 2.3, 2.6**

  - [x] 2.8 实现跨平台系统服务
    - 实现 Windows 服务注册
    - 实现 macOS launchd 配置
    - 实现 Linux systemd 配置
    - _需求: 2.7_

  - [ ]* 2.9 编写跨平台兼容性测试
    - 测试 Windows、macOS、Linux 服务启动
    - **属性 21: 跨平台功能一致性**
    - _需求: 2.7, 6.1, 6.3, 6.4_

- [ ] 3. 检查点 - 验证 Shadowd 功能
  - 确保所有测试通过，如有问题请询问用户。

- [x] 4. M3: 实现移动端网络连接与设备发现
  - [x] 4.1 创建 React Native 项目结构
    - 初始化 React Native 项目（TypeScript）
    - 配置 Zustand 状态管理
    - 设置项目目录结构（screens、components、services、stores）
    - _需求: 3.1_

  - [x] 4.2 实现 VPN 连接管理
    - 集成 WireGuard 原生模块（iOS/Android）
    - 实现 VPN 连接/断开逻辑
    - 实现连接状态管理（Zustand store）
    - _需求: 3.1, 3.2_

  - [ ]* 4.3 编写 VPN 连接属性测试
    - **属性 6: VPN 连接性能**
    - **属性 7: VPN 断开清理**
    - **验证需求: 3.1, 3.2, 7.1**

  - [ ]* 4.4 编写 VPN 错误处理属性测试
    - **属性 10: VPN 连接错误处理**
    - **验证需求: 3.6**

  - [x] 4.5 实现设备发现和管理
    - 实现 gRPC 客户端（调用 Shadowd 接口）
    - 实现设备列表状态管理
    - 实现设备在线状态检测（HealthCheck）
    - 实现自动刷新机制（30 秒间隔）
    - _需求: 3.3, 3.5_

  - [ ]* 4.6 编写设备发现属性测试
    - **属性 8: 设备发现和状态同步**
    - **验证需求: 3.3, 3.5**

  - [x] 4.7 实现二维码扫码配对
    - 集成二维码扫描库
    - 实现二维码数据解析（PairingCode）
    - 实现时间戳验证（防重放攻击）
    - 实现设备添加到本地存储
    - _需求: 3.4_

  - [ ]* 4.8 编写二维码配对属性测试
    - **属性 9: 配对二维码往返**
    - **验证需求: 3.4**

  - [x] 4.9 实现设备信息本地持久化
    - 使用 AsyncStorage 存储设备列表
    - 实现设备信息加载和保存
    - _需求: 3.7_

  - [ ]* 4.10 编写设备持久化属性测试
    - **属性 11: 设备信息持久化往返（移动端）**
    - **验证需求: 3.7**

  - [x] 4.11 实现设备列表 UI
    - 创建设备列表屏幕
    - 实现设备卡片组件（显示名称、OS、在线状态）
    - 实现 VPN 连接/断开按钮
    - 实现添加设备按钮（扫码）
    - _需求: 3.3, 3.4_

- [ ] 5. 检查点 - 验证网络连接功能
  - 确保所有测试通过，如有问题请询问用户。

- [x] 6. M4: 实现移动端专家终端
  - [x] 6.1 实现 SSH 连接服务
    - 集成 SSH 客户端库（react-native-ssh）
    - 实现 SSH 连接管理类（SSHService）
    - 实现连接、断开、Shell 启动
    - 实现数据读写和事件监听
    - _需求: 4.1, 4.2_

  - [ ]* 6.2 编写 SSH 连接属性测试
    - **属性 12: SSH 连接建立**
    - **验证需求: 4.1**

  - [ ]* 6.3 编写 SSH 断线处理属性测试
    - **属性 15: SSH 断线检测和恢复**
    - **属性 16: SSH 会话资源清理**
    - **验证需求: 4.4, 4.5**

  - [x] 6.4 实现终端 UI 组件
    - 创建终端屏幕组件
    - 实现输出显示区域（ScrollView）
    - 实现命令输入框
    - 实现基本终端功能（光标、选择、复制粘贴）
    - _需求: 4.2, 4.6_

  - [ ]* 6.5 编写终端 UI 单元测试
    - 测试组件渲染
    - 测试用户输入处理
    - 测试基本终端功能
    - _需求: 4.6_

  - [x] 6.6 实现命令执行和输出显示
    - 实现命令发送逻辑
    - 实现输出接收和显示
    - 实现输出缓冲和滚动
    - _需求: 4.3_

  - [ ]* 6.7 编写命令执行属性测试
    - **属性 13: 命令执行完整性和性能**
    - **属性 14: 命令输出显示性能**
    - **验证需求: 4.3, 7.2, 7.3**

  - [x] 6.8 实现 ANSI 转义序列渲染
    - 集成 ANSI 解析库
    - 实现颜色和格式渲染
    - 实现特殊字符处理
    - _需求: 4.7_

  - [ ]* 6.9 编写 ANSI 渲染属性测试
    - **属性 17: ANSI 转义序列渲染**
    - **验证需求: 4.7**

  - [x] 6.10 实现设备指纹验证
    - 实现首次连接指纹显示
    - 实现用户确认对话框
    - 实现指纹存储和验证
    - _需求: 5.5_

  - [ ]* 6.11 编写设备指纹验证属性测试
    - **属性 20: 设备指纹验证**
    - **验证需求: 5.5**

  - [x] 6.12 实现 SSH 私钥安全存储
    - 使用平台安全存储（Keychain/Keystore）
    - 实现密钥生成和存储
    - 实现密钥读取和使用
    - _需求: 5.4_

  - [ ]* 6.13 编写密钥存储单元测试
    - 验证密钥存储在安全区域
    - 测试密钥读取和使用
    - _需求: 5.4_

- [ ] 7. 检查点 - 验证终端功能
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 8. 实现统一错误处理和日志
  - [ ] 8.1 实现 Shadowd 错误处理和日志
    - 创建统一的错误类型定义
    - 实现日志记录器（支持不同级别）
    - 集成到所有模块
    - _需求: 8.4_

  - [ ] 8.2 实现移动端错误处理和日志
    - 创建统一的错误处理服务
    - 实现错误显示组件（Toast/Alert）
    - 实现日志记录（开发/生产模式）
    - _需求: 8.4_

  - [ ]* 8.3 编写错误处理属性测试
    - **属性 22: 统一错误处理和日志**
    - **验证需求: 8.4**

- [ ] 9. 集成测试和端到端验证
  - [ ]* 9.1 编写端到端集成测试
    - 测试完整流程：设备注册 → VPN 连接 → 设备发现 → SSH 连接 → 命令执行
    - 测试跨模块交互
    - _需求: 所有需求_

  - [ ]* 9.2 编写性能测试
    - 测试并发 SSH 会话（10+ 会话）
    - 测试 VPN 连接时间
    - 测试命令执行延迟
    - _需求: 7.1, 7.2, 7.3, 7.4_

  - [ ]* 9.3 编写安全测试
    - 测试外部访问拒绝
    - 测试密钥认证强制
    - 测试指纹验证流程
    - _需求: 5.1, 5.2, 5.3, 5.5_

- [ ] 10. 最终检查点 - 完整系统验证
  - 确保所有测试通过，系统功能完整，如有问题请询问用户。

## 注意事项

- 标记 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
