# 🔐 使用系统用户密码

## ✅ 已切换到系统 SSH 服务器

现在 WebSocket 代理连接到系统的 SSH 服务器（端口 22），使用真实的系统用户密码。

## 📋 工作原理

### 之前（shadowd SSH 服务器）

```
手机 App → WebSocket (8022) → shadowd SSH (2222) → 自定义密码验证
```

### 现在（系统 SSH 服务器）

```
手机 App → WebSocket (8022) → 系统 SSH (22) → 系统用户密码验证
```

## 🧪 测试步骤

### 1. 确认系统 SSH 已开启

```bash
# macOS
sudo systemsetup -getremotelogin
# 应该显示: Remote Login: On

# 如果未开启，执行：
sudo systemsetup -setremotelogin on
```

### 2. 测试 WebSocket 连接

```bash
cd shadowd

# 使用你的 Mac 用户密码测试
node test-system-ssh.js a0000 your_mac_password
```

### 3. 预期结果

```
✅ WebSocket 连接成功
✅ SSH 认证成功！
✅ 已连接到系统 SSH 服务器
📥 输出: a0000
📥 输出: /Users/a0000
```

## 📱 在手机 App 中使用

### 1. 打开 App

### 2. 点击设备

### 3. 输入系统用户凭据

- **用户名：** 你的 Mac 用户名（例如：`a0000`）
- **密码：** 你的 Mac 登录密码（系统密码）

### 4. 连接

- ✅ 使用正确的系统密码 → 连接成功
- ❌ 使用错误的密码 → 认证失败

## 🔍 验证真实性

### 测试 1：正确的系统密码

```
用户名: a0000
密码: [你的 Mac 密码]
结果: ✅ 连接成功，可以执行命令
```

### 测试 2：错误的密码

```
用户名: a0000
密码: wrong_password
结果: ❌ 认证失败
```

### 测试 3：执行系统命令

连接成功后，执行：

```bash
whoami        # 显示当前用户
pwd           # 显示当前目录
ls ~          # 列出主目录文件
echo $HOME    # 显示 HOME 环境变量
```

应该看到真实的系统输出。

## 🔐 安全性

### 优点

✅ **使用系统密码**
- 不需要额外配置
- 与系统登录密码一致
- 系统级别的安全验证

✅ **真实的 SSH 连接**
- 连接到系统 SSH 服务器
- 完整的 shell 环境
- 所有系统命令可用

✅ **加密传输**
- WebSocket 可升级到 WSS（加密）
- SSH 本身已加密
- 双重加密保护

### 注意事项

⚠️ **密码安全**
- 不要在不安全的网络中使用
- 建议使用 VPN 或 Mesh 网络
- 考虑使用公钥认证

⚠️ **系统访问**
- 拥有完整的系统访问权限
- 可以执行任何命令
- 需要谨慎操作

## 🎯 下一步优化

### 短期（当前可用）

✅ 使用系统用户密码
✅ 真实的 SSH 连接
✅ 完整的 shell 环境

### 中期（推荐）

📅 **公钥认证**
- 生成 SSH 密钥对
- 配置 authorized_keys
- 在 App 中存储私钥

📅 **WSS 加密**
- 配置 SSL 证书
- 升级到 WSS 协议
- 更安全的传输

### 长期（企业级）

📅 **多因素认证**
- 集成 2FA
- 生物识别
- 硬件密钥

📅 **审计日志**
- 记录所有连接
- 命令执行日志
- 安全审计

## 📝 常见问题

### Q: 为什么要使用系统 SSH 而不是 shadowd SSH？

**A:**
- 系统 SSH 使用真实的用户密码
- 不需要额外配置用户
- 更符合用户期望
- 更安全（系统级验证）

### Q: 如何修改系统用户密码？

**A:**
```bash
# macOS
passwd

# 或在系统偏好设置中修改
```

### Q: 可以使用其他用户登录吗？

**A:**
可以！只要该用户：
- 在系统中存在
- 有 SSH 登录权限
- 知道正确的密码

### Q: 如何禁用密码认证，只使用公钥？

**A:**
编辑 `/etc/ssh/sshd_config`：
```
PasswordAuthentication no
PubkeyAuthentication yes
```

然后重启 SSH 服务。

### Q: 连接失败怎么办？

**A:**
检查：
1. 系统 SSH 是否开启
2. 用户名是否正确
3. 密码是否正确
4. 防火墙是否阻止
5. 查看系统日志：`log show --predicate 'process == "sshd"' --last 5m`

## 🧪 测试清单

- [ ] 系统 SSH 已开启
- [ ] shadowd 正在运行
- [ ] WebSocket 端口 8022 监听
- [ ] 使用正确的用户名
- [ ] 使用正确的系统密码
- [ ] 可以执行系统命令
- [ ] 看到真实的输出

## 📚 相关文件

- `shadowd/main.go` - WebSocket 配置（连接到端口 22）
- `shadowd/test-system-ssh.js` - 测试脚本
- `mobile-app/src/services/sshService.ts` - 客户端实现

---

**现在使用你的 Mac 系统密码登录！** 🎉

**重要提示：**
- 用户名：你的 Mac 用户名
- 密码：你的 Mac 登录密码（不是之前的测试密码）
